{% extends "main.html" %}
{% block headtitle %}{{ title }}{% endblock %}
{% block headnav %}
    <a class="btn btn-outline-primary" href="{{ url_for('home') }}">Home</a>
{% endblock %}
{% block body %}
<div class="row">
    <div class="col-md-12">
        <form method="POST" id="employeeForm" data-validation='{"validateOnInput": true, "validateOnBlur": true, "showCharacterCounters": true, "showRealTimeFeedback": true}'>
            {{ form.hidden_tag() }}
            
            <div class="row mb-3">
                <label class="col-sm-2 col-form-label">{{ form.fullname.label }}</label>
                <div class="col-sm-10">
                    {{ form.fullname(class="form-control", placeholder="Enter full name (e.g., John Doe)", maxlength="100") }}
                    {% if form.fullname.errors %}
                        {% for error in form.fullname.errors %}
                            <span class="text-danger">{{ error }}</span>
                        {% endfor %}
                    {% endif %}
                </div>
            </div>
            
            <div class="row mb-3">
                <label class="col-sm-2 col-form-label">{{ form.location.label }}</label>
                <div class="col-sm-10">
                    {{ form.location(class="form-control", placeholder="Enter location (e.g., Seattle, WA)", maxlength="100") }}
                    {% if form.location.errors %}
                        {% for error in form.location.errors %}
                            <span class="text-danger">{{ error }}</span>
                        {% endfor %}
                    {% endif %}
                </div>
            </div>
            
            <div class="row mb-3">
                <label class="col-sm-2 col-form-label">{{ form.job_title.label }}</label>
                <div class="col-sm-10">
                    {{ form.job_title(class="form-control", placeholder="Enter job title (e.g., Software Engineer)", maxlength="100") }}
                    {% if form.job_title.errors %}
                        {% for error in form.job_title.errors %}
                            <span class="text-danger">{{ error }}</span>
                        {% endfor %}
                    {% endif %}
                </div>
            </div>
            
            <div class="row mb-3">
                <label class="col-sm-2 col-form-label">Badges</label>
                <div class="col-sm-10">
                    <div id="badgesContainer">
                        {% for badge_key, badge_name in badges.items() %}
                        <div class="form-check form-check-inline">
                            <input class="form-check-input" type="checkbox" 
                                   id="badge_{{ badge_key }}" 
                                   value="{{ badge_key }}"
                                   {% if badge_key in (form.badges.data or '').split(',') %}checked{% endif %}
                                   onchange="updateBadges()">
                            <label class="form-check-label" for="badge_{{ badge_key }}">
                                <i class="fa fa-{{ badge_key }}"></i> {{ badge_name }}
                            </label>
                        </div>
                        {% endfor %}
                    </div>
                    {{ form.badges(class="form-control", style="display: none;") }}
                </div>
            </div>
            
            <div class="row mb-3">
                <div class="col-sm-10 offset-sm-2">
                    <div class="d-grid gap-2 d-md-block">
                        <button type="submit" class="btn btn-primary" id="submitBtn">
                            <span class="btn-text">
                                {% if employee %}Update{% else %}Add{% endif %} Employee
                            </span>
                        </button>
                        <a href="{{ url_for('home') }}" class="btn btn-secondary">Cancel</a>
                        <button type="button" class="btn btn-outline-info" onclick="resetFormValidation()">
                            <i class="fa fa-refresh"></i> Reset Validation
                        </button>
                    </div>
                </div>
            </div>
        </form>
    </div>
</div>

<script>
// Initialize form validation
let formValidator;

document.addEventListener('DOMContentLoaded', function() {
    // Initialize the form validator
    formValidator = new FormValidator('employeeForm', {
        validateOnInput: true,
        validateOnBlur: true,
        showCharacterCounters: true,
        showRealTimeFeedback: true,
        debounceDelay: 300
    });
    
    // Enhanced form submission with loading states
    const form = document.getElementById('employeeForm');
    const submitBtn = document.getElementById('submitBtn');
    
    if (form && submitBtn) {
        form.addEventListener('submit', function(e) {
            // Validate all fields before submission
            if (!formValidator.validateAllFields()) {
                e.preventDefault();
                return false;
            }
            
            // Show form loading state
            LoadingManager.showFormLoading(form);
            
            // Show button loading state
            const originalText = submitBtn.querySelector('.btn-text').textContent;
            LoadingManager.showButtonLoading(submitBtn);
            
            // Store original text for restoration
            submitBtn.dataset.originalText = originalText;
            
            // Add a small delay to show loading state
            setTimeout(() => {
                // Form will submit naturally
            }, 200);
        });
    }
    
    // Add loading state to badge checkboxes
    const badgeCheckboxes = document.querySelectorAll('input[type="checkbox"]');
    badgeCheckboxes.forEach(checkbox => {
        checkbox.addEventListener('change', function() {
            const label = this.nextElementSibling;
            if (label) {
                label.style.opacity = '0.7';
                setTimeout(() => {
                    label.style.opacity = '1';
                }, 300);
            }
        });
    });
});

function updateBadges() {
    // Show loading state for badge update
    const badgesContainer = document.getElementById('badgesContainer');
    badgesContainer.classList.add('badge-loading');
    
    setTimeout(() => {
        const checkboxes = document.querySelectorAll('input[type="checkbox"]');
        const selectedBadges = [];
        
        checkboxes.forEach(checkbox => {
            if (checkbox.checked) {
                selectedBadges.push(checkbox.value);
            }
        });
        
        document.getElementById('badges').value = selectedBadges.join(',');
        
        // Hide loading state
        badgesContainer.classList.remove('badge-loading');
    }, 100);
}

function resetFormValidation() {
    if (formValidator) {
        formValidator.resetValidation();
    }
    
    // Clear form fields
    const form = document.getElementById('employeeForm');
    form.reset();
    
    // Reset badge selection
    const checkboxes = document.querySelectorAll('input[type="checkbox"]');
    checkboxes.forEach(checkbox => {
        checkbox.checked = false;
    });
    document.getElementById('badges').value = '';
    
    // Show success message
    showMessage('Form has been reset successfully!', 'success');
}

function showMessage(message, type = 'info') {
    // Create message element
    const messageDiv = document.createElement('div');
    messageDiv.className = `alert alert-${type === 'success' ? 'success' : 'info'} alert-dismissible fade show`;
    messageDiv.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    // Insert at the top of the form
    const form = document.getElementById('employeeForm');
    form.insertBefore(messageDiv, form.firstChild);
    
    // Auto-remove after 5 seconds
    setTimeout(() => {
        if (messageDiv.parentNode) {
            messageDiv.remove();
        }
    }, 5000);
}

// Enhanced validation feedback
function validateFieldOnBlur(field) {
    if (formValidator) {
        formValidator.validateField(field, field.name);
    }
}

// Real-time character counting
function updateCharacterCount(field, maxLength) {
    const currentLength = field.value.length;
    const percentage = (currentLength / maxLength) * 100;
    
    // Find or create character counter
    let counter = field.parentNode.querySelector('.char-counter');
    if (!counter) {
        counter = document.createElement('div');
        counter.className = 'char-counter';
        field.parentNode.appendChild(counter);
    }
    
    counter.textContent = `${currentLength} / ${maxLength}`;
    counter.className = 'char-counter';
    
    if (percentage >= 90) {
        counter.classList.add('at-limit');
    } else if (percentage >= 75) {
        counter.classList.add('near-limit');
    }
}
</script>
{% endblock %}
