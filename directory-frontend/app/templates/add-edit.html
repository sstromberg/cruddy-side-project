{% extends "main.html" %}
{% block headtitle %}{{ title }}{% endblock %}
{% block headnav %}
    <a class="btn btn-outline-secondary" href="{{ url_for('home') }}">
        <i class="fa fa-arrow-left me-2"></i>Back to Dogs
    </a>
{% endblock %}
{% block body %}
<div class="row">
    <div class="col-md-8 mx-auto">
        <div class="card shadow">
            <div class="card-header">
                <h3 class="mb-0">
                    <i class="fa fa-paw me-2"></i>{{ title }}
                </h3>
            </div>
            <div class="card-body">
                <form method="POST" id="dogForm" data-validation='{"validateOnInput": true, "validateOnBlur": true, "showCharacterCounters": true, "showRealTimeFeedback": true}'>
                    {{ form.hidden_tag() }}
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                {{ form.name.label(class="form-label") }}
                                {{ form.name(class="form-control", placeholder="Enter dog name (e.g., Max)", maxlength="100") }}
                                {% if form.name.errors %}
                                    <div class="text-danger">
                                        {% for error in form.name.errors %}
                                            <small>{{ error }}</small>
                                        {% endfor %}
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                {{ form.approx_age.label(class="form-label") }}
                                {{ form.approx_age(class="form-control", placeholder="Enter approximate age (e.g., 3 years, 6 months)", maxlength="50") }}
                                {% if form.approx_age.errors %}
                                    <div class="text-danger">
                                        {% for error in form.approx_age.errors %}
                                            <small>{{ error }}</small>
                                        {% endfor %}
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                {{ form.size.label(class="form-label") }}
                                {{ form.size(class="form-control") }}
                                {% if form.size.errors %}
                                    <div class="text-danger">
                                        {% for error in form.size.errors %}
                                            <small>{{ error }}</small>
                                        {% endfor %}
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                {{ form.breed_type.label(class="form-label") }}
                                {{ form.breed_type(class="form-control", placeholder="Enter breed or type (e.g., Golden Retriever, Mixed)", maxlength="100") }}
                                {% if form.breed_type.errors %}
                                    <div class="text-danger">
                                        {% for error in form.breed_type.errors %}
                                            <small>{{ error }}</small>
                                        {% endfor %}
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    
                    <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                        <a href="{{ url_for('home') }}" class="btn btn-secondary me-md-2">
                            <i class="fa fa-times me-2"></i>Cancel
                        </a>
                        <button type="submit" class="btn btn-primary" id="submitBtn">
                            <span class="btn-text">
                                {% if dog %}Update{% else %}Add{% endif %} Dog
                            </span>
                        </button>
                        <button type="button" class="btn btn-outline-info" onclick="resetFormValidation()">
                            <i class="fa fa-refresh"></i> Reset Validation
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
// Initialize form validation
let formValidator;

document.addEventListener('DOMContentLoaded', function() {
    // Initialize the form validator
    formValidator = new FormValidator('dogForm', {
        validateOnInput: true,
        validateOnBlur: true,
        showCharacterCounters: true,
        showRealTimeFeedback: true,
        debounceDelay: 300
    });
    
    // Enhanced form submission with loading states
    const form = document.getElementById('dogForm');
    const submitBtn = document.getElementById('submitBtn');
    
    if (form && submitBtn) {
        form.addEventListener('submit', function(e) {
            // Validate all fields before submission
            if (!formValidator.validateAllFields()) {
                e.preventDefault();
                return false;
            }
            
            // Show form loading state
            LoadingManager.showFormLoading(form);
            
            // Show button loading state
            const originalText = submitBtn.querySelector('.btn-text').textContent;
            LoadingManager.showButtonLoading(submitBtn);
            
            // Store original text for restoration
            submitBtn.dataset.originalText = originalText;
            
            // Add a small delay to show loading state
            setTimeout(() => {
                // Form will submit naturally
            }, 200);
        });
    }
    
    // Add loading state to form fields
    const formFields = document.querySelectorAll('.form-control');
    formFields.forEach(field => {
        field.addEventListener('change', function() {
            const fieldContainer = this.parentNode;
            if (fieldContainer) {
                fieldContainer.style.opacity = '0.7';
                setTimeout(() => {
                    fieldContainer.style.opacity = '1';
                }, 300);
            }
        });
    });
});

function resetFormValidation() {
    if (formValidator) {
        formValidator.resetValidation();
    }
    
    // Clear form fields
    const form = document.getElementById('dogForm');
    form.reset();
    
    // Show success message
    showMessage('Form has been reset successfully!', 'success');
}

function showMessage(message, type = 'info') {
    // Create message element
    const messageDiv = document.createElement('div');
    messageDiv.className = `alert alert-${type === 'success' ? 'success' : 'info'} alert-dismissible fade show`;
    messageDiv.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    // Insert at the top of the form
    const form = document.getElementById('dogForm');
    form.insertBefore(messageDiv, form.firstChild);
    
    // Auto-remove after 5 seconds
    setTimeout(() => {
        if (messageDiv.parentNode) {
            messageDiv.remove();
        }
    }, 5000);
}

// Enhanced validation feedback
function validateFieldOnBlur(field) {
    if (formValidator) {
        formValidator.validateField(field, field.name);
    }
}

// Real-time character counting
function updateCharacterCount(field, maxLength) {
    const currentLength = field.value.length;
    const percentage = (currentLength / maxLength) * 100;
    
    // Find or create character counter
    let counter = field.parentNode.querySelector('.char-counter');
    if (!counter) {
        counter = document.createElement('div');
        counter.className = 'char-counter';
        field.parentNode.appendChild(counter);
    }
    
    counter.textContent = `${currentLength} / ${maxLength}`;
    counter.className = 'char-counter';
    
    if (percentage >= 90) {
        counter.classList.add('at-limit');
    } else if (percentage >= 75) {
        counter.classList.add('near-limit');
    }
}
</script>
{% endblock %}
